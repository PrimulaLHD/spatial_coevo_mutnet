---
title: Workflow for SI
output: pdf_document
fontsize: 10pt
---
   
## Sort of pertubation theory

```{r packs, results = 'hide'}
require(doMC)
registerDoMC(cores = 3)
require(plotrix)
require(dplyr)
require(magrittr)
require(ggplot2)
require(plyr)
require(RColorBrewer)
```
   
First, let's source the function that executes simulations.

```{r init}
source('functions/coevoMutNet2Sites_array.R')

Norm <- function(x) sqrt(sum(x*x))
```

### Simple Scenario

We start this workflow with a simple scenario: 5 species of each type, totaling 10 species, with a perfectly nested interaction structure:

```{r set_sp, fig.cap = 'Simple adjacency matrix for twenty species with a perfectly nested structure. White cells represent ones, black cells represent zeroes.', fig.asp = 1}
n_row <- 5
n_col <- 5
n_sp <- n_row + n_col

mat <- matrix(0, n_row, n_col)
for(i in 1:n_row)
    for(j in 1:n_col)
        mat[i, j] <- ifelse(i >= j, 1, 0)

zeros_row <- matrix(0, n_row, n_row)
zeros_col <- matrix(0, n_col, n_col)

f <- rbind(cbind(zeros_row, mat), cbind(t(mat), zeros_col))

color2D.matplot(f, axes = FALSE, xlab = '', ylab = '', asp = 1)
```

An initial simulation scenario would be in the absence of either "abiotic" interactions and gene flow between communities.
This scenario can be represented by setting the following parameters:

```{r scenario1}
## environmental optimum, not used in this scenario
## but the function needs some values to run                                       
theta_A <- rnorm(n_sp, 0, 1) 
theta_B <- rnorm(n_sp, 0, 1)

h2 <- 0.1 # heritability

g = 0 # gene flow
p_A = 1 # hotness of A
p_B = 1 # hotness of B

alpha = 0.1
## in this scenario, changing alpha should not induce funky behavior
## it appears to increase variance around weighted average initial condition
## still gotta test this

epsilon = 0.000001
t_max = 100000
```

In this scenario, we expect that every species should have the same value, corresponding to the mean of initial values at each community, weighted by the degree of each species.

```{r sim_scen1, cache = TRUE}
diffA <- diffB <- c()

## check if there is no variance in final values
varA <- varB <- c()

for(i in 1:1000)
    {
        init_A <- rnorm(n_sp, 0, 1)
        init_B <- rnorm(n_sp, 0, 1)
        
        degree <- rowSums(f)
        
        wmeanA <- sum(init_A * degree) / sum(degree)
        wmeanB <- sum(init_B * degree) / sum(degree)

        Z <-
            CoevoMutNet2Sites_array(n_sp,
                                    f = f,
                                    g = rep(g, n_sp),
                                    h = rep(h2, n_sp),
                                    alpha = alpha,
                                    theta_A, theta_B,
                                    init_A, init_B,
                                    m_A = rep(p_A, n_sp),
                                    m_B = rep(p_B, n_sp),
                                    epsilon = 1e-6, t_max)
        
        final <- Z [dim(Z)[1], , ]

        varA[i] <- var(final [, 'A'])
        varB[i] <- var(final [, 'B'])
        
        wm_fin_A <- sum(degree * final [, 'A']) / sum(degree)
        wm_fin_B <- sum(degree * final [, 'B']) / sum(degree)

        diffA[i] <- wm_fin_A - wmeanA
        diffB[i] <- wm_fin_B - wmeanB
    }
```

So, the distribution of differences between weighted means for initial and final values should be centered at zero:

```{r hist_scen1, fig.cap = 'Distribution of differences between weighted averages for initial conditions and weighted averages for final values after simulation.'}
par(mfrow = c(1, 2))
hist(diffA, main = '', xlab = 'Site A')
hist(diffB, main = '', xlab = 'Site B')
```

And all values of species in either sites should be the same, thus having zero variance:

```{r var_scen1}
summary(varA)
summary(varB)
```

Looks zero to me.

### Perturbations

In this simple setting, it is clear that local populations would converge in their phenotypes, and such convergence would depend both on initial conditions and the underlying interaction network.
Initial conditions of central species  (hm, so maybe supergeneralists invading some community would strongly shift phenotypes of composing populations?).
Local communities would thus exhibit perfect trait matching (or maybe not so perfect, but perfect *on average*).

Now, we focus on perturbations onto this initial scenario.
First we introduce gene flow, and observing its effect on the same statistics obtained in the first scenario: the difference between weighted means for initial and final values in either communities, and variances within each community.

(gotta look at the spectrum)

```{r scenario2, cache = TRUE}

g <- seq(0.001, 0.1, by = 0.001)

set.seed(1037)

scen2 <-
    aaply(1:100, 1, function(i)
    {
        aaply(1:length(g), 1, function(j)
        {
            
            init_A <- rnorm(n_sp, 10, sqrt(10))
            init_B <- rnorm(n_sp, 20, sqrt(10))
            
            degree <- rowSums(f)
            
            wmeanA <- sum(init_A * degree) / sum(degree)
            wmeanB <- sum(init_B * degree) / sum(degree)
            
            Z <- CoevoMutNet2Sites_array(n_sp,
                                         f = f,
                                         g = rep(g[j], n_sp),
                                         h = rep(h2, n_sp),
                                         alpha = alpha,
                                         theta_A, theta_B,
                                         init_A, init_B,
                                         m_A = rep(p_A, n_sp),
                                         m_B = rep(p_B, n_sp),
                                         epsilon = 1e-6, t_max)
            
            final <- Z [dim(Z)[1], , ]
            
            varA <- var(final [, 'A'])
            varB <- var(final [, 'B'])
            
            wm_fin_A <- sum(degree * final [, 'A']) / sum(degree)
            wm_fin_B <- sum(degree * final [, 'B']) / sum(degree)
            
            diffA <- wm_fin_A - wmeanA
            diffB <- wm_fin_B - wmeanB

           c(diffA, diffB, varA, varB) 
    })}, .parallel = TRUE)

```

```{r scen2_handling, fig.cap='Distribution of the sum of differences between weighted means for initial and final values for both sites, for values of gene flow between 0 and 0.1.'}

names(dimnames(scen2)) [2] <- 'geneflow'
dimnames(scen2) [[2]] <- as.character(g)
dimnames(scen2) [[3]] <- c('diffA', 'diffB', 'varA', 'varB')

scen2.df <- adply(scen2, 2)

ggplot(scen2.df) +
    geom_violin(aes(x = geneflow, y = (diffA + diffB))) +
    theme_bw() + 
    theme(axis.text.x = element_text(angle = 90, size = 2))
```

```{r scen2_summ}

summary(scen2.df $ varA)
summary(scen2.df $ varB)
```

Distributions of traits on both sites are shifted with respect to initial conditions, on average by the same amount, still without variation within species on each site.


### No mutualisms

Set new set of parameters to represent the absence of interactions between species and gene flow:

```{r scenario3, cache = TRUE}
set.seed(665)

## environmental optimum
theta_A <- rnorm(n_sp, 10, sqrt(10)) 
theta_B <- rnorm(n_sp, 20, sqrt(10))

h2 <- 0.1 # heritability

g = 0 # gene flow
p_A = 0 # hotness of A
p_B = 0 # hotness of B

alpha = 0
## in this scenario, alpha does not matter (right?)

epsilon = 1e-8
t_max = 100000

meanA <- meanB <- c()

## keep variance
varA <- varB <- c()

for(i in 1:1000)
    {
        init_A <- rnorm(n_sp, 20, sqrt(10))
        init_B <- rnorm(n_sp, 10, sqrt(10))

        theta_A <- rnorm(n_sp, 10, sqrt(10)) 
        theta_B <- rnorm(n_sp, 20, sqrt(10))
        
        Z <-
            CoevoMutNet2Sites_array(n_sp,
                                    f = f,
                                    g = rep(g, n_sp),
                                    h = rep(h2, n_sp),
                                    alpha = alpha,
                                    theta_A, theta_B,
                                    init_A, init_B,
                                    m_A = rep(p_A, n_sp),
                                    m_B = rep(p_B, n_sp),
                                    epsilon, t_max)
        
        final <- Z [dim(Z)[1], , ]

        varA[i] <- var(final [, 'A']) - var(theta_A)
        varB[i] <- var(final [, 'B']) - var(theta_B)
        
        meanA[i] <- mean(final [, 'A']) - mean(theta_A)
        meanB[i] <- mean(final [, 'B']) - mean(theta_B)
    }
```

```{r hist_scen3, fig.cap = 'Distribution of average final values on a simulation without interactions.'}
par(mfrow = c(1, 2))
hist(meanA, main = '', xlab = 'Site A')
hist(meanB, main = '', xlab = 'Site B')
```

In this case, the final distribution of traits in both communities converge to the distribution of environmental optima: each species simply goes to its own optimum, without regard to other species.

```{r var_scen3}
summary(varA)
summary(varB)
```

Now, how does gene flow interact with the evolution of traits in a community without interactions?

```{r scen3_flow, cache = TRUE}
g <- seq(0.001, 0.1, by = 0.001)

set.seed(2901)

scen3 <-
    aaply(1:100, 1, function(i)
    {
        meanA <- meanB <- c()

        ## keep variance
        varA <- varB <- c()

        aaply(1:length(g), 1, function(j)
        {
            init_A <- rnorm(n_sp, 20, sqrt(10))
            init_B <- rnorm(n_sp, 10, sqrt(10))

            theta_A <- rnorm(n_sp, 10, sqrt(10)) 
            theta_B <- rnorm(n_sp, 20, sqrt(10))
        
            Z <-
                CoevoMutNet2Sites_array(n_sp,
                                        f = f,
                                        g = rep(g[i], n_sp),
                                        h = rep(h2, n_sp),
                                        alpha = alpha,
                                        theta_A, theta_B,
                                        init_A, init_B,
                                        m_A = rep(p_A, n_sp),
                                        m_B = rep(p_B, n_sp),
                                        epsilon, t_max)
        
            final <- Z [dim(Z)[1], , ]

            varA <- var(final [, 'A']) - var(theta_A)
            varB <- var(final [, 'B']) - var(theta_B)
        
            meanA <- mean(final [, 'A']) - mean(theta_A)
            meanB <- mean(final [, 'B']) - mean(theta_B)
            
            c(meanA, meanB, varA, varB) 
    })}, .parallel = TRUE)
```

```{r scen3_handling}

names(dimnames(scen3)) [2] <- 'geneflow'
dimnames(scen3) [[2]] <- as.character(g)
dimnames(scen3) [[3]] <- c('meanA', 'meanB', 'varA', 'varB')

scen3.df <- adply(scen3, 2)

ggplot(scen3.df) +
    geom_violin(aes(x = geneflow, y = meanA), color = 'blue') +
    geom_violin(aes(x = geneflow, y = meanB), color = 'red') +
    theme_bw() + 
    theme(axis.text.x = element_text(angle = 90, size = 2))
```

Means for both sites deviate the same amount, regardless of how much gene flow there is.
Now, what determines such amount?

Nonetheless, it appears that the effect of gene flow is somewhat simple in either scenario, with a binary effect: if it is on, it mixed the distribution of values in a linear fashion.

### Mixing up

So, considering only the effect of interactions between focal species, the community converges to a single trait values, which depends on the weighted average of initial conditions.
Conversely, when interactions are removed, each species converge to its own "abiotic" optimum, so that the distribution of final values matches the distribution of these optima.
Thus, what happens when both effects are combined?

```{r hot2cold, cache = TRUE}

set.seed(971)

h2 <- 0.1 # heritability

g = 0.05 # gene flow
p_A = seq(0.95, 0.05, by = -0.025) # hotness of A
p_B = 1 # hotness of B

alpha = 0.1

h2c <-
    aaply(1:100, 1, function(j)
    {

        theta_A <- rnorm(n_sp, 20, sqrt(10)) 
        theta_B <- rnorm(n_sp, 40, sqrt(10))

        init_A <- runif(n_sp, 10, 30)
        init_B <- runif(n_sp, 30, 50)
            
        degree <- rowSums(f)
            
        wmeanA <- sum(init_A * degree) / sum(degree)
        wmeanB <- sum(init_B * degree) / sum(degree)

        aaply(p_A, 1, function(p)
        {
            Z <- CoevoMutNet2Sites_array(n_sp,
                                         f = f,
                                         g = rep(g, n_sp),
                                         h = rep(h2, n_sp),
                                         alpha = alpha,
                                         theta_A, theta_B,
                                         init_A, init_B,
                                         m_A = rep(p, n_sp),
                                         m_B = rep(p_B, n_sp),
                                         epsilon = 1e-6, t_max)
            
            final <- Z [dim(Z)[1], , ]
            
            varA <- var(final [, 'A'])
            varB <- var(final [, 'B'])
            
            wm_fin_A <- sum(degree * final [, 'A']) / sum(degree)
            wm_fin_B <- sum(degree * final [, 'B']) / sum(degree)
            
            meanA <- mean(final [, 'A'])
            meanB <- mean(final [, 'B'])
            
            dist.theta.A <- Norm(final [, 'A'] - theta_A)
            dist.theta.B <- Norm(final [, 'B'] - theta_B)
            
            c(p, meanA, meanB, wmeanA, wmeanB, wm_fin_A, wm_fin_B,
              dist.theta.A, dist.theta.B, varA, varB)
            
    })}, .parallel = TRUE)

```

```{r h2c_hand, fig.cap = 'Difference in weighted average between initial and final values for sites A (red) and B (blue) plotted against relative importance of mutualistic interactions in site A.',  warnings = FALSE}

h2c.df <- adply(h2c, 1)
colnames(h2c.df) <- c('init', 'hotness', 'meanA', 'meanB',
                      'wmeanA', 'wmeanB', 'wm_fin_A', 'wm_fin_B',
                      'dist.theta.A', 'dist.theta.B', 'varA', 'varB') 

h2c.df [, -1] %>%
    plyr::mutate(diffA = wm_fin_A - wmeanA, diffB = wm_fin_B - wmeanB) %>%
    group_by(hotness) %>%
    summarise_each(funs(mean)) %>%
    ggplot(.) +
    geom_line(aes(x = hotness, y = diffA), color = 'red') +
    geom_line(aes(x = hotness, y = diffB), color = 'blue') +
    theme_bw()

```

```{r h2c_plots}
h2c.df [, -1] %>%
    group_by(hotness) %>%
    summarise_each(funs(mean)) %>%
    ggplot(.) +
    geom_line(aes(x = hotness, y = dist.theta.A), color = 'red') +
    geom_line(aes(x = hotness, y = dist.theta.B), color = 'blue') +
    theme_bw()
```

It appears that the difference between weighted means for initial and final values in either sites is independent of the relative importance of mutualistic and abiotic interactions on site A (in this case, site B is as "hot" as it can be).

Probably, actual final values depend on the distribution parameters of initial conditions.

Now what happens when we increase the hotness in a site connected to a cold spot?

```{r cold2hot, cache = TRUE}

set.seed(97)

h2 <- 0.1 # heritability

g = 0.05 # gene flow
p_A = seq(0.95, 0.05, by = -0.025) # hotness of A
p_B = 0 # hotness of B

alpha = 0.1

c2h <-
    aaply(1:100, 1, function(j)
    {

        theta_A <- rnorm(n_sp, 20, sqrt(10)) 
        theta_B <- rnorm(n_sp, 40, sqrt(10))

        init_A <- runif(n_sp, 10, 30)
        init_B <- runif(n_sp, 30, 50)
            
        degree <- rowSums(f)
            
        wmeanA <- sum(init_A * degree) / sum(degree)
        wmeanB <- sum(init_B * degree) / sum(degree)

        aaply(p_A, 1, function(p)
        {
            Z <- CoevoMutNet2Sites_array(n_sp,
                                         f = f,
                                         g = rep(g, n_sp),
                                         h = rep(h2, n_sp),
                                         alpha = alpha,
                                         theta_A, theta_B,
                                         init_A, init_B,
                                         m_A = rep(p, n_sp),
                                         m_B = rep(p_B, n_sp),
                                         epsilon = 1e-6, t_max)
            
            final <- Z [dim(Z)[1], , ]
            
            varA <- var(final [, 'A'])
            varB <- var(final [, 'B'])
            
            wm_fin_A <- sum(degree * final [, 'A']) / sum(degree)
            wm_fin_B <- sum(degree * final [, 'B']) / sum(degree)
            
            meanA <- mean(final [, 'A'])
            meanB <- mean(final [, 'B'])
            
            dist.theta.A <- Norm(final [, 'A'] - theta_A)
            dist.theta.B <- Norm(final [, 'B'] - theta_B)
            
            c(p, meanA, meanB, wmeanA, wmeanB, wm_fin_A, wm_fin_B,
              dist.theta.A, dist.theta.B, varA, varB)
            
    })}, .parallel = TRUE)

```

```{r c2h_hand, fig.cap = 'Difference in weighted average between initial and final values for sites A (red) and B (blue) plotted against relative importance of mutualistic interactions in site A.',  warnings = FALSE}

c2h.df <- adply(c2h, 1)
colnames(c2h.df) <- c('init', 'hotness', 'meanA', 'meanB',
                      'wmeanA', 'wmeanB', 'wm_fin_A', 'wm_fin_B',
                      'dist.theta.A', 'dist.theta.B', 'varA', 'varB') 

c2h.df [, -1] %>%
    plyr::mutate(diffA = wm_fin_A - wmeanA, diffB = wm_fin_B - wmeanB) %>%
    group_by(hotness) %>%
    summarise_each(funs(mean)) %>%
    ggplot(.) +
    geom_line(aes(x = hotness, y = diffA), color = 'red') +
    geom_line(aes(x = hotness, y = diffB), color = 'blue') +
    theme_bw()

```

```{r c2h_plots}
c2h.df [, -1] %>%
    group_by(hotness) %>%
    summarise_each(funs(mean)) %>%
    ggplot(.) +
    geom_line(aes(x = hotness, y = dist.theta.A), color = 'red') +
    geom_line(aes(x = hotness, y = dist.theta.B), color = 'blue') +
    theme_bw()

```
